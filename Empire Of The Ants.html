<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Империята На Мравките</title>
    <style>
        body { margin: 0; overflow: hidden; display: flex; justify-content: center; align-items: center; height: 100vh; background-color: #f2f2f2; }
        canvas { border: 2px solid black; background-color: #e1e1e1; }
        .ui { position: fixed; top: 10px; left: 10px; z-index: 10; background: rgba(0, 0, 0, 0.5); color: white; padding: 10px; }
        #startButton { font-size: 20px; width: 200px; height: 60px; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); transition: transform 0.3s; }
        #startButton:hover { transform: translate(-50%, -50%) scale(1.1); }
        #spawnSoldierButton, #spawnWorkerButton, #followButton, #howToPlayButton, #shopButton { padding: 10px; font-size: 14px; margin-top: 10px; cursor: pointer; border: none; color: rgb(0, 0, 0); }
        #spawnSoldierButton { background-color: rgb(221, 25, 25); }
        #spawnWorkerButton { background-color: rgb(83, 19, 231); }
        #followButton { background-color: green; }
        #howToPlayButton { background-color: #FFB400; }
        #shopButton { background-color: #24b4b4; }
        #spawnSoldierButton:disabled, #spawnWorkerButton:disabled { background-color: gray; cursor: not-allowed; }
        #timer { position: fixed; right: 10px; bottom: 10px; font-size: 24px; color: black; }
        #howToPlayMessage, #shopMenu {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border: 2px solid black;
            padding: 20px;
            z-index: 20;
        }
        #shopMenu button {
            background-color: #24b4b4;
            margin-top: 10px;
        }
    </style>
    
</head>
<body>
<canvas id="gameCanvas" tabindex="0"></canvas>
<button id="startButton">Старт</button>
<div class="ui" id="uiControls" style="display:none;">
    <p>Работни мравки: <span id="workerCount">0</span></p>
    <p>Войници мравки: <span id="soldierCount">0</span></p>
    <p>Събрани листа: <span id="leafCount">0</span></p>
    <p>Събрани семена: <span id="seedCount">0</span></p>
    <button id="spawnSoldierButton" disabled>Купи войник</button>
    <button id="spawnWorkerButton" disabled>Купи работник</button>
    <button id="followButton">Следвай ме</button>
    <button id="howToPlayButton">Как да играя</button>
    <button id="shopButton">Магазин</button>
</div>

<div id="howToPlayMessage">
    <p>Добре дошли в играта! Вашата цел е да събирате листа и семена с помощта на мравки, за да развиете вашето гнездо.</p>
    <p>Използвайте клавишите със стрелки за движение и наемете работници или войници за повече възможности.</p>
    <button id="closeMessageButton">Затвори</button>
</div>

<div id="shopMenu">
    <h3>Магазин</h3>
    <p>Купуват се само с семена!</p>
    <button id="speedBoostButton">Ускоряване 1.5 пъти повече за 40 семена</button>
    <button id="closeShopButton">Затвори магазина</button>
</div>

<script>
    // Constants and initial setup
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    const WORLD_WIDTH = 850;
    const WORLD_HEIGHT = 620;
    let leaves = [];
    let seeds = [];
    let workerAnts = [];
    let soldierAnts = [];
    let collectedLeaves = 0;
    let collectedSeeds = 0;
    let workerCount = 0;
    let soldierCount = 0;
    let soldiersFollowPlayer = false;

    let player = { x: 750, y: 500, speed: 3, size: 5, carryingLeaf: false, carryingSeed: false };
    let nest = { x: WORLD_WIDTH / 2, y: WORLD_HEIGHT / 2, size: 30 };

    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    const pressedKeys = {};
    window.addEventListener("keydown", (event) => { pressedKeys[event.code] = true; });
    window.addEventListener("keyup", (event) => { delete pressedKeys[event.code]; });

    function spawnInitialItems() {
        for (let i = 0; i < 200; i++) {
            leaves.push({ x: Math.random() * WORLD_WIDTH, y: Math.random() * WORLD_HEIGHT, size: 5.5 });
            seeds.push({ x: Math.random() * WORLD_WIDTH, y: Math.random() * WORLD_HEIGHT, size: 4 });
        }
    }

    function gameLoop() {
        update();
        draw();
        requestAnimationFrame(gameLoop);
    }

    function update() {
        movePlayer();
        updateAnts();
        checkCollisions();
        updateUI();
    }

    function movePlayer() {
        const speed = player.carryingLeaf || player.carryingSeed ? player.speed / 2 : player.speed;
        if (pressedKeys["ArrowUp"]) player.y -= speed;
        if (pressedKeys["ArrowDown"]) player.y += speed;
        if (pressedKeys["ArrowLeft"]) player.x -= speed;
        if (pressedKeys["ArrowRight"]) player.x += speed;
    }

    function updateAnts() {
        const workerSpeed = player.speed * 0.4;
        workerAnts.forEach(ant => {
            if (!ant.carryingLeaf && !ant.carryingSeed) {
                const closestItem = findClosestItem(ant, [...leaves, ...seeds]);
                if (closestItem) {
                    moveTowards(ant, closestItem, workerSpeed);
                    if (isCloseEnough(ant, closestItem)) {
                        if (leaves.includes(closestItem)) {
                            ant.carryingLeaf = true;
                            leaves.splice(leaves.indexOf(closestItem), 1);
                        } else if (seeds.includes(closestItem)) {
                            ant.carryingSeed = true;
                            seeds.splice(seeds.indexOf(closestItem), 1);
                        }
                    }
                }
            } else {
                moveTowards(ant, nest, workerSpeed);
                if (isCloseEnough(ant, nest)) {
                    if (ant.carryingLeaf) {
                        ant.carryingLeaf = false;
                        collectedLeaves++;
                    } else if (ant.carryingSeed) {
                        ant.carryingSeed = false;
                        collectedSeeds++;
                    }
                }
            }
        });

        const soldierSpeed = player.speed * 2;
        soldierAnts.forEach(ant => {
            moveTowards(ant, soldiersFollowPlayer ? player : nest, soldierSpeed);
        });
    }

    function isCloseEnough(a, b, threshold = 10) {
        return Math.hypot(a.x - b.x, a.y - b.y) < threshold;
    }

    function moveTowards(entity, target, speed) {
        const angle = Math.atan2(target.y - entity.y, target.x - entity.x);
        entity.x += Math.cos(angle) * speed;
        entity.y += Math.sin(angle) * speed;
    }

    function findClosestItem(ant, items) {
        return items.reduce((closest, item) => {
            const distanceToItem = Math.hypot(ant.x - item.x, ant.y - item.y);
            const distanceToClosest = Math.hypot(ant.x - closest.x, ant.y - closest.y);
            return distanceToItem < distanceToClosest ? item : closest;
        }, items[0]);
    }

    function checkCollisions() {
        if (!player.carryingLeaf && !player.carryingSeed) {
            for (const leaf of leaves) {
                if (isCloseEnough(player, leaf)) {
                    player.carryingLeaf = true;
                    leaves.splice(leaves.indexOf(leaf), 1);
                    break;
                }
            }
            for (const seed of seeds) {
                if (isCloseEnough(player, seed)) {
                    player.carryingSeed = true;
                    seeds.splice(seeds.indexOf(seed), 1);
                    break;
                }
            }
        }

        if ((player.carryingLeaf || player.carryingSeed) && isCloseEnough(player, nest)) {
            if (player.carryingLeaf) {
                player.carryingLeaf = false;
                collectedLeaves++;
            } else if (player.carryingSeed) {
                player.carryingSeed = false;
                collectedSeeds++;
            }
        }
    }

    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        ctx.fillStyle = "brown";
        ctx.beginPath();
        ctx.arc(nest.x, nest.y, nest.size, 0, Math.PI * 2);
        ctx.fill();

        ctx.fillStyle = "green";
        leaves.forEach(leaf => {
            ctx.beginPath();
            ctx.arc(leaf.x, leaf.y, leaf.size, 0, Math.PI * 2);
            ctx.fill();
        });

        ctx.fillStyle = "orange";
        seeds.forEach(seed => {
            ctx.beginPath();
            ctx.arc(seed.x, seed.y, seed.size, 0, Math.PI * 2);
            ctx.fill();
        });

        ctx.fillStyle = player.carryingLeaf || player.carryingSeed ? "black" : "black";
        ctx.beginPath();
        ctx.arc(player.x, player.y, player.size, 0, Math.PI * 2);
        ctx.fill();

        ctx.fillStyle = "gray";
        workerAnts.forEach(ant => {
            ctx.beginPath();
            ctx.arc(ant.x, ant.y, 4, 0, Math.PI * 2);
            ctx.fill();
        });

        ctx.fillStyle = "blue";
        soldierAnts.forEach(ant => {
            ctx.beginPath();
            ctx.arc(ant.x, ant.y, 5, 0, Math.PI * 2);
            ctx.fill();
        });
    }

    function updateUI() {
        document.getElementById("workerCount").textContent = workerCount;
        document.getElementById("soldierCount").textContent = soldierCount;
        document.getElementById("leafCount").textContent = collectedLeaves;
        document.getElementById("seedCount").textContent = collectedSeeds;
        document.getElementById("spawnWorkerButton").disabled = collectedLeaves < 1;
        document.getElementById("spawnSoldierButton").disabled = collectedLeaves < 5;
    }

    document.getElementById("startButton").addEventListener("click", function() {
        document.getElementById("startButton").style.display = "none";
        document.getElementById("uiControls").style.display = "block";
        spawnInitialItems();
        gameLoop();
    });

    document.getElementById("spawnWorkerButton").addEventListener("click", function() {
        if (collectedLeaves >= 1) {
            collectedLeaves--;
            workerCount++;
            workerAnts.push({ x: nest.x, y: nest.y, carryingLeaf: false, carryingSeed: false });
        }
        updateUI();
    });

    document.getElementById("spawnSoldierButton").addEventListener("click", function() {
        if (collectedLeaves >= 5) {
            collectedLeaves -= 5;
            soldierCount++;
            soldierAnts.push({ x: nest.x, y: nest.y });
        }
        updateUI();
    });

    document.getElementById("followButton").addEventListener("click", function() {
        soldiersFollowPlayer = !soldiersFollowPlayer;
        document.getElementById("followButton").textContent = soldiersFollowPlayer ? "Стой в гнездото" : "Следвай ме";
    });

    document.getElementById("howToPlayButton").addEventListener("click", function() {
        document.getElementById("howToPlayMessage").style.display = "block";
    });

    document.getElementById("closeMessageButton").addEventListener("click", function() {
        document.getElementById("howToPlayMessage").style.display = "none";
    });

    document.getElementById("shopButton").addEventListener("click", function() {
        document.getElementById("shopMenu").style.display = "block";
    });

    document.getElementById("closeShopButton").addEventListener("click", function() {
        document.getElementById("shopMenu").style.display = "none";
    });

    document.getElementById("speedBoostButton").addEventListener("click", function() {
        if (collectedSeeds >= 40) {
            collectedSeeds -= 40;
            player.speed *= 1.5;
            setTimeout(() => { player.speed /= 1.5; }, 30000);
        }
        updateUI();
    });

    document.getElementById("giftBoxButton").addEventListener("click", function() {
        if (collectedSeeds >= 10) {
            collectedSeeds -= 10;
            openGiftBox();
        }
        updateUI();
    });

    

    document.getElementById("timer").textContent = "Таймер: 120 секунди";

    spawnInitialItems();
</script>
</body>
</html>
